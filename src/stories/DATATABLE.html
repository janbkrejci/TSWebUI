<div class="sl-theme-{{theme}} main-container">
    <style>
        #page-number {
            max-width: 4em;
            display: inline-block;
        }

        #page-number::part(input) {
            text-align: right;
        }

        #page-info,
        #item-count,
        #items-per-page {
            font-size: var(--sl-font-size-small);
            color: var(--sl-color-neutral-700);
            font-weight: var(--sl-font-weight-light);
            white-space: nowrap;
        }

        #items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5em;
            flex-wrap: nowrap;
        }

        #pager {
            display: flex;
            align-items: center;
            gap: 0.5em;
            align-self: center;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .table-container {
            overflow-x: auto;
            width: 100%;
            margin: 0;
        }

        #container {
            min-width: 700px;
            padding: 1em;
        }

        #footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5em 0;
            margin-top: 1em;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            flex-wrap: nowrap;
        }

        table {
            width: auto;
            border-collapse: collapse;
            background: var(--sl-color-neutral-0);
            color: var(--sl-color-neutral-1000);
            font-family: var(--sl-font-sans);
            box-shadow: var(--sl-shadow-x-large);
            border-radius: var(--sl-border-radius-large);
            overflow: hidden;
        }

        thead {
            background: var(--sl-color-neutral-100);
        }

        th,
        td {
            padding: 0.5em 1em;
            border-bottom: 1px solid var(--sl-color-neutral-200);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        th {
            font-weight: var(--sl-font-weight-semibold);
            color: var(--sl-color-neutral-900);
            background: var(--sl-color-neutral-100);
            text-align: left;
        }

        .filter-row th {
            padding: 0.25em 1em;
            border-bottom: 1px solid var(--sl-color-neutral-200);
            background: var(--sl-color-neutral-50);
        }

        .filter-row sl-input {
            width: 100%;
        }

        th:first-child,
        td:first-child {
            text-align: center;
        }

        th:nth-child(2),
        td:nth-child(2) {
            text-align: right;
        }

        tr:hover td {
            background: var(--sl-color-primary-50);
        }

        tbody tr {
            cursor: pointer;
        }

        /* Main container styles */
        .main-container {
            padding: 1em;
            background-color: var(--sl-color-neutral-0);
            color: var(--sl-color-neutral-1000);
            font-family: var(--sl-font-sans);
        }

        /* Toolbar styles */
        .toolbar {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
            padding: 0.5em 0;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            gap: 0.5em;
        }

        .toolbar-center {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 0.25em;
        }

        /* Menu styles */
        .columns-menu {
            min-width: 200px;
        }

        .search-input {
            margin: 0.5em;
            width: calc(100% - 1em);
        }

        /* Table header styles */
        .checkbox-column {
            width: 40px;
        }

        .id-column {
            width: 40px;
        }

        /* Sort indicator styles */
        .sort-indicator {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.25em;
        }

        .sort-svg {
            vertical-align: middle;
        }

        /* Footer styles */
        .footer {
            display: flex;
            gap: 0.5em;
            justify-content: space-between;
            align-items: center;
            margin-top: 1em;
            padding: 0.5em 0;
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5em;
            font-size: var(--sl-font-size-small);
            color: var(--sl-color-neutral-700);
            font-weight: var(--sl-font-weight-light);
            white-space: nowrap;
        }

        .pager {
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .chevron-icon {
            margin-left: 0.5em;
        }
    </style>
    <script>
        // select all on focus
        let inputClick = (event) => {
            event.target.select();
            event.preventDefault();
        };
        let inputKeyDown = (event) => {
            //ignore non-numeric keys except backspace and delete
            if (!/[0-9]/.test(event.key) && event.key !== 'Backspace' && event.key !== 'Delete' && event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
                event.preventDefault();
            }
            // blur on enter
            if (event.key === 'Enter') {
                event.target.blur();
            }
        };
        // on blur, ensure value is between 1 and 15
        let inputBlur = (event) => {
            let value = parseInt(event.target.value);
            if (isNaN(value) || value < 1) {
                event.target.value = 1;
            } else if (value > 15) {
                event.target.value = 15;
            }
        };
        // handle row click
        let rowClicked = (event) => {
            // Prevent firing if clicking on checkbox or its contents
            if (event.target.closest('sl-checkbox') || event.target.tagName === 'SL-CHECKBOX') {
                return;
            }
            // Get the row that was clicked
            let row = event.currentTarget;
            // Get the ID from the second cell (index 1)
            let id = row.cells[1].textContent;
            // Log to console
            console.log('Row clicked with ID:', id);
        };

        // Column visibility mapping
        const columnMap = {
            'ID': 1,
            'Name': 2,
            'Username': 3,
            'Email': 4,
            'City': 5,
            'Phone': 6,
            'Website': 7,
            'Company': 8
        };

        // Handle column visibility changes
        let columnVisibilityChanged = (event) => {
            // Find the menu item (might be a child element that triggered the event)
            let menuItem = event.target;
            if (menuItem.tagName !== 'SL-MENU-ITEM') {
                menuItem = menuItem.closest('sl-menu-item');
            }

            if (!menuItem) {
                console.error('Could not find menu item');
                return;
            }

            const columnName = menuItem.textContent.trim();
            const columnIndex = columnMap[columnName];

            console.log(`Column "${columnName}" (index ${columnIndex}) visibility changed`);

            if (columnIndex !== undefined) {
                // For Shoelace menu items, check the current state
                const isChecked = menuItem.hasAttribute('checked');
                console.log(`Current state: ${isChecked ? 'checked' : 'unchecked'}`);

                // Toggle the state
                const newChecked = !isChecked;
                if (newChecked) {
                    menuItem.setAttribute('checked', '');
                } else {
                    menuItem.removeAttribute('checked');
                }

                console.log(`New state: ${newChecked ? 'checked' : 'unchecked'}`);
                console.log(`Setting column ${columnIndex} visibility to: ${newChecked ? 'visible' : 'hidden'}`);

                toggleColumnVisibility(columnIndex, newChecked);
            } else {
                console.warn(`Column "${columnName}" not found in columnMap`);
            }
        };        // Toggle column visibility
        let toggleColumnVisibility = (columnIndex, isVisible) => {
            console.log(`Toggling column ${columnIndex} visibility to: ${isVisible ? 'SHOW' : 'HIDE'}`);
            const table = document.querySelector('table');
            if (!table) {
                console.error('Table not found!');
                return;
            }

            // Get all rows (header and body)
            const rows = table.querySelectorAll('tr');
            console.log(`Found ${rows.length} rows to update`);

            let updatedCells = 0;
            rows.forEach((row, rowIndex) => {
                const cell = row.cells[columnIndex];
                if (cell) {
                    cell.style.display = isVisible ? '' : 'none';
                    updatedCells++;
                    if (rowIndex === 0) { // Log header row
                        console.log(`Header cell ${columnIndex} set to: ${isVisible ? 'visible' : 'hidden'}`);
                    }
                } else {
                    console.warn(`Cell at row ${rowIndex}, column ${columnIndex} not found`);
                }
            });
            console.log(`Updated ${updatedCells} cells for column ${columnIndex}`);
        };        // Handle Select All
        let selectAllColumns = () => {
            console.log('Select All clicked');
            const menuItems = document.querySelectorAll('sl-menu-item[type="checkbox"]');
            console.log(`Found ${menuItems.length} menu items`);
            menuItems.forEach((item, index) => {
                if (!item.hasAttribute('checked')) {
                    item.setAttribute('checked', '');
                    // Directly show the column since we know it should be checked
                    const columnName = item.textContent.trim();
                    const columnIndex = columnMap[columnName];
                    console.log(`Checking item ${index}: ${columnName} (column ${columnIndex})`);
                    if (columnIndex !== undefined) {
                        toggleColumnVisibility(columnIndex, true);
                    }
                }
            });
        };

        // Handle Clear All
        let clearAllColumns = () => {
            console.log('Clear All clicked');
            const menuItems = document.querySelectorAll('sl-menu-item[type="checkbox"]');
            console.log(`Found ${menuItems.length} menu items`);
            menuItems.forEach((item, index) => {
                if (item.hasAttribute('checked')) {
                    item.removeAttribute('checked');
                    // Directly hide the column since we know it should be unchecked
                    const columnName = item.textContent.trim();
                    const columnIndex = columnMap[columnName];
                    console.log(`Unchecking item ${index}: ${columnName} (column ${columnIndex})`);
                    if (columnIndex !== undefined) {
                        toggleColumnVisibility(columnIndex, false);
                    }
                }
            });
        };

        // Initialize column visibility on page load
        let initializeColumnVisibility = () => {
            // Wait for data attribute to be available
            const checkForDataAttribute = () => {
                const container = document.getElementById('container');
                const selectedColumnsData = container?.getAttribute('data-selected-columns');
                
                if (selectedColumnsData && selectedColumnsData !== '{{selectedColumns}}') {
                    // Data attribute is ready
                    updateColumnChooserFromStoryParams();
                } else {
                    // Try again in a short delay
                    setTimeout(checkForDataAttribute, 100);
                }
            };
            
            checkForDataAttribute();
        };

        // Reactive function to update column chooser from story parameters
        let updateColumnChooserFromStoryParams = () => {
            console.log('Updating column chooser from story params');
            // Get selected columns from data attribute
            const container = document.getElementById('container');
            const selectedColumnsData = container?.getAttribute('data-selected-columns');
            const selectedColumns = selectedColumnsData ? JSON.parse(selectedColumnsData) : ['Name', 'Username', 'Email'];
            console.log('Selected columns from data attribute:', selectedColumns);

            // First, hide all columns
            console.log('Hiding all columns first');
            hideAllColumns();

            // Set checkbox states and show selected columns
            const menuItems = document.querySelectorAll('sl-menu-item[type="checkbox"]');
            console.log(`Found ${menuItems.length} menu items to update`);
            menuItems.forEach((item, index) => {
                const columnName = item.textContent.trim();
                const shouldBeChecked = selectedColumns.includes(columnName);
                console.log(`Item ${index}: ${columnName}, should be checked: ${shouldBeChecked}`);
                if (shouldBeChecked) {
                    item.setAttribute('checked', '');
                    // Show the column
                    const columnIndex = columnMap[columnName];
                    console.log(`Showing column ${columnName} at index ${columnIndex}`);
                    if (columnIndex !== undefined) {
                        toggleColumnVisibility(columnIndex, true);
                    }
                } else {
                    item.removeAttribute('checked');
                    // Column is already hidden from hideAllColumns()
                }
            });
        };

        // Hide all table columns
        let hideAllColumns = () => {
            console.log('Hiding all columns');
            const table = document.querySelector('table');
            if (!table) {
                console.log('No table found');
                return;
            }

            const rows = table.querySelectorAll('tr');
            console.log(`Found ${rows.length} rows to process`);
            rows.forEach((row, rowIndex) => {
                console.log(`Processing row ${rowIndex} with ${row.cells.length} cells`);
                // Hide all columns except the checkbox column (index 0)
                for (let i = 1; i < row.cells.length; i++) {
                    const cell = row.cells[i];
                    if (cell) {
                        cell.style.display = 'none';
                        console.log(`Hidden cell ${i} in row ${rowIndex}`);
                    }
                }
                // Ensure checkbox column is always visible
                const checkboxCell = row.cells[0];
                if (checkboxCell) {
                    checkboxCell.style.display = '';
                    console.log(`Ensured checkbox cell in row ${rowIndex} is visible`);
                }
            });
        };

        // Global function for Storybook to update column parameters
        window.updateDataTableColumns = (selectedColumns) => {
            const container = document.getElementById('container');
            if (container) {
                container.setAttribute('data-selected-columns', JSON.stringify(selectedColumns));
                // The mutation observer will handle the update
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeColumnVisibility();
            watchForStoryParameterChanges();
        });

        // Global function for Storybook to update column parameters
        window.updateDataTableColumns = (selectedColumns) => {
            const container = document.getElementById('container');
            if (container) {
                container.setAttribute('data-selected-columns', JSON.stringify(selectedColumns));
                // The mutation observer will handle the update
            }
        };
    </script>
    <div id="container" data-selected-columns="{{selectedColumns}}">
        <!-- DATATABLE -->
        <!-- Toolbar -->
        <div class="toolbar">
            <div>
                <sl-button variant="success" circle>
                    <sl-icon name="plus"></sl-icon>
                </sl-button>
            </div>
            <div class="toolbar-center">
                <sl-button variant="danger">
                    <sl-icon name="trash"></sl-icon>
                </sl-button>
                <sl-button>Export to Excel</sl-button>
            </div>
            <div>
                <sl-dropdown>
                    <sl-button slot="trigger" caret>Columns</sl-button>
                    <sl-menu class="columns-menu">
                        <sl-menu-item onclick="selectAllColumns()">Select All</sl-menu-item>
                        <sl-menu-item onclick="clearAllColumns()">Clear All</sl-menu-item>
                        <sl-divider></sl-divider>
                        <sl-input placeholder="Search columns..." class="search-input"></sl-input>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">ID</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Name</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Username</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Email</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">City</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Phone</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Website</sl-menu-item>
                        <sl-menu-item type="checkbox" onclick="columnVisibilityChanged(event)">Company</sl-menu-item>
                    </sl-menu>
                </sl-dropdown>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-column"></th>
                        <th class="id-column">ID</th>
                        <th>Name
                            <span class="sort-indicator">
                                <svg width="10" height="16" viewBox="0 0 10 16" class="sort-svg">
                                    <polygon points="5,3 1,7 9,7" fill="var(--sl-color-neutral-500)" />
                                    <polygon points="5,13 1,9 9,9" fill="var(--sl-color-neutral-300)" />
                                </svg>
                            </span>
                        </th>
                        <th>Username
                            <span class="sort-indicator">
                                <svg width="10" height="16" viewBox="0 0 10 16" class="sort-svg">
                                    <polygon points="5,3 1,7 9,7" fill="var(--sl-color-neutral-300)" />
                                    <polygon points="5,13 1,9 9,9" fill="var(--sl-color-neutral-500)" />
                                </svg>
                            </span>
                        </th>
                        <th>Email</th>
                        <th>City</th>
                        <th>Phone</th>
                        <th>Website</th>
                        <th>Company</th>
                    </tr>
                    <tr class="filter-row">
                        <th class="checkbox-column"><sl-checkbox></sl-checkbox></th>
                        <th><sl-input size="small" placeholder="Filter ID"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Name"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Username"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Email"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter City"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Phone"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Website"></sl-input></th>
                        <th><sl-input size="small" placeholder="Filter Company"></sl-input></th>
                    </tr>
                </thead>
                <tbody>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>1</td>
                        <td>Leanne Graham</td>
                        <td>Bret</td>
                        <td>leanne@example.com</td>
                        <td>London</td>
                        <td>555-1234</td>
                        <td>www.leannegraham.com</td>
                        <td>Example Corp</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>2</td>
                        <td>Ervin Howell</td>
                        <td>Antonette</td>
                        <td>ervin@example.com</td>
                        <td>Paris</td>
                        <td>555-5678</td>
                        <td>www.ervinhowell.com</td>
                        <td>Howell LLC</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>3</td>
                        <td>Clementine Bauch</td>
                        <td>Samantha</td>
                        <td>clementine@example.com</td>
                        <td>Berlin</td>
                        <td>555-8765</td>
                        <td>www.clementine.com</td>
                        <td>Bauch Group</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>4</td>
                        <td>Patricia Lebsack</td>
                        <td>Karianne</td>
                        <td>patricia@example.com</td>
                        <td>Madrid</td>
                        <td>555-4321</td>
                        <td>www.patricia.com</td>
                        <td>Lebsack Ltd</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>5</td>
                        <td>Chelsey Dietrich</td>
                        <td>Kameron</td>
                        <td>chelsey@example.com</td>
                        <td>Rome</td>
                        <td>555-2468</td>
                        <td>www.chelsey.com</td>
                        <td>Dietrich Inc</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>6</td>
                        <td>Mrs. Dennis Schulist</td>
                        <td>Leopoldo_Corkery</td>
                        <td>dennis@example.com</td>
                        <td>Vienna</td>
                        <td>555-1357</td>
                        <td>www.dennis.com</td>
                        <td>Schulist Group</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>7</td>
                        <td>Kurtis Weissnat</td>
                        <td>Elwyn.Skiles</td>
                        <td>kurtis@example.com</td>
                        <td>Prague</td>
                        <td>555-9753</td>
                        <td>www.kurtis.com</td>
                        <td>Weissnat LLC</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>8</td>
                        <td>Nicholas Runolfsdottir</td>
                        <td>Maxime_Nienow</td>
                        <td>nicholas@example.com</td>
                        <td>Brno</td>
                        <td>555-8642</td>
                        <td>www.nicholas.com</td>
                        <td>Runolfsdottir Ltd</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>9</td>
                        <td>Glenna Reichert</td>
                        <td>Delphine</td>
                        <td>glenna@example.com</td>
                        <td>Ostrava</td>
                        <td>555-7531</td>
                        <td>www.glenna.com</td>
                        <td>Reichert Group</td>
                    </tr>
                    <tr onclick="rowClicked(event)">
                        <td><sl-checkbox></sl-checkbox></td>
                        <td>10</td>
                        <td>Clementina DuBuque</td>
                        <td>Moriah.Stanton</td>
                        <td>clementina@example.com</td>
                        <td>Plzeň</td>
                        <td>555-1597</td>
                        <td>www.clementina.com</td>
                        <td>DuBuque Inc</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- FOOTER -->
        <div class="footer">
            <div id="item-count">Vybráno 10 z 500</div>
            <div class="items-per-page">
                Zobrazit
                <sl-dropdown>
                    <sl-button slot="trigger">
                        10
                        <sl-icon name="chevron-down" class="chevron-icon"></sl-icon>
                    </sl-button>

                    <sl-menu>
                        <sl-menu-item>5</sl-menu-item>
                        <sl-menu-item>10</sl-menu-item>
                        <sl-menu-item>20</sl-menu-item>
                        <sl-menu-item>50</sl-menu-item>
                        <sl-menu-item>100</sl-menu-item>
                        <sl-menu-item>1000</sl-menu-item>
                    </sl-menu>
                </sl-dropdown>
                na stránku
            </div>
            <!-- PAGER -->
            <div class="pager" onclick="pageDropdownClicked(event)">
                <sl-button-group>
                    <sl-button disabled>
                        <sl-icon name="chevron-bar-left"></sl-icon>
                    </sl-button>
                    <sl-button disabled>
                        <sl-icon name="chevron-left"></sl-icon>
                    </sl-button>
                </sl-button-group>
                <div id="page-info" variant="none">
                    Stránka
                    <sl-input id="page-number" size="small" value="8" onclick="inputClick(event)"
                        onkeydown="inputKeyDown(event)" onblur="inputBlur(event)"></sl-input>
                    / 15
                </div>

                <sl-button-group>
                    <sl-button>
                        <sl-icon name="chevron-right"></sl-icon>
                    </sl-button>
                    <sl-button>
                        <sl-icon name="chevron-bar-right"></sl-icon>
                    </sl-button>
                </sl-button-group>
            </div>
        </div>
    </div>
</div>