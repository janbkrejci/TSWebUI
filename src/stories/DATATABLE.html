<div class="sl-theme-{{theme}} main-container">
    <script>
        // Utility functions for page number input
        let inputClick = (event) => {
            event.target.select();
            event.preventDefault();
        };
        
        let inputKeyDown = (event) => {
            if (!/[0-9]/.test(event.key) && event.key !== 'Backspace' && event.key !== 'Delete' && event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
                event.preventDefault();
            }
            if (event.key === 'Enter') {
                event.target.blur();
            }
        };
        
        let inputBlur = (event) => {
            let value = parseInt(event.target.value);
            if (isNaN(value) || value < 1) {
                event.target.value = 1;
            } else if (value > 15) {
                event.target.value = 15;
            }
        };

        // Table data
        const tableData = [
            {
                id: 1,
                name: "Leanne Graham",
                username: "Bret",
                email: "leanne@example.com",
                city: "London",
                phone: "555-1234",
                website: "www.leannegraham.com",
                company: "Example Corp"
            },
            {
                id: 2,
                name: "Ervin Howell",
                username: "Antonette",
                email: "ervin@example.com",
                city: "Paris",
                phone: "555-5678",
                website: "www.ervinhowell.com",
                company: "Howell LLC"
            },
            {
                id: 3,
                name: "Clementine Bauch",
                username: "Samantha",
                email: "clementine@example.com",
                city: "Berlin",
                phone: "555-8765",
                website: "www.clementine.com",
                company: "Bauch Group"
            },
            {
                id: 4,
                name: "Patricia Lebsack",
                username: "Karianne",
                email: "patricia@example.com",
                city: "Madrid",
                phone: "555-4321",
                website: "www.patricia.com",
                company: "Lebsack Ltd"
            },
            {
                id: 5,
                name: "Chelsey Dietrich",
                username: "Kameron",
                email: "chelsey@example.com",
                city: "Rome",
                phone: "555-2468",
                website: "www.chelsey.com",
                company: "Dietrich Inc"
            },
            {
                id: 6,
                name: "Mrs. Dennis Schulist",
                username: "Leopoldo_Corkery",
                email: "dennis@example.com",
                city: "Vienna",
                phone: "555-1357",
                website: "www.dennis.com",
                company: "Schulist Group"
            },
            {
                id: 7,
                name: "Kurtis Weissnat",
                username: "Elwyn.Skiles",
                email: "kurtis@example.com",
                city: "Prague",
                phone: "555-9753",
                website: "www.kurtis.com",
                company: "Weissnat LLC"
            },
            {
                id: 8,
                name: "Nicholas Runolfsdottir",
                username: "Maxime_Nienow",
                email: "nicholas@example.com",
                city: "Brno",
                phone: "555-8642",
                website: "www.nicholas.com",
                company: "Runolfsdottir Ltd"
            },
            {
                id: 9,
                name: "Glenna Reichert",
                username: "Delphine",
                email: "glenna@example.com",
                city: "Ostrava",
                phone: "555-7531",
                website: "www.glenna.com",
                company: "Reichert Group"
            },
            {
                id: 10,
                name: "Clementina DuBuque",
                username: "Moriah.Stanton",
                email: "clementina@example.com",
                city: "Plzeň",
                phone: "555-1597",
                website: "www.clementina.com",
                company: "DuBuque Inc"
            }
        ];

        // Column definitions for dynamic table creation
        const columnDefinitions = [
            { 
                key: 'id', 
                title: 'ID', 
                sortable: false, 
                sortDirection: 'none',
                className: 'id-column',
                filterable: true,
                filterPlaceholder: 'Filter ID',
                visible: false,
                align: 'right'
            },
            { 
                key: 'name', 
                title: 'Name', 
                sortable: true, 
                sortDirection: 'asc',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Name',
                visible: true,
                align: 'left'
            },
            { 
                key: 'username', 
                title: 'Username', 
                sortable: true, 
                sortDirection: 'desc',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Username',
                visible: false,
                align: 'left'
            },
            { 
                key: 'email', 
                title: 'Email', 
                sortable: false, 
                sortDirection: 'none',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Email',
                visible: false,
                align: 'left'
            },
            { 
                key: 'city', 
                title: 'City', 
                sortable: false, 
                sortDirection: 'none',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter City',
                visible: false,
                align: 'left'
            },
            { 
                key: 'phone', 
                title: 'Phone', 
                sortable: false, 
                sortDirection: 'none',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Phone',
                visible: false,
                align: 'center'
            },
            { 
                key: 'website', 
                title: 'Website', 
                sortable: false, 
                sortDirection: 'none',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Website',
                visible: false,
                align: 'left'
            },
            { 
                key: 'company', 
                title: 'Company', 
                sortable: false, 
                sortDirection: 'none',
                className: '',
                filterable: true,
                filterPlaceholder: 'Filter Company',
                visible: false,
                align: 'left'
            }
        ];

        // Column visibility configuration
        const preselectedColumns = ['name', 'email'];
        const unhideableColumns = ['name', 'email'];

        // Function to get visible columns based on column definitions
        function getVisibleColumns() {
            return columnDefinitions.filter(col => col.visible);
        }

        // Function to select all columns (respecting unhideable columns)
        function selectAllColumns() {
            // Update column definitions
            columnDefinitions.forEach(col => {
                col.visible = true;
            });

            // Recreate menu to reflect changes
            createColumnsMenu();
            populateTable();
        }

        // Function to clear all columns (respecting unhideable columns)
        function clearAllColumns() {
            // Update column definitions (keep unhideable columns visible)
            columnDefinitions.forEach(col => {
                if (!unhideableColumns.includes(col.key)) {
                    col.visible = false;
                }
            });

            // Recreate menu to reflect changes
            createColumnsMenu();
            populateTable();
        }

        // Handle row clicks
        let rowClicked = (event) => {
            if (event.target.closest('sl-checkbox') || event.target.tagName === 'SL-CHECKBOX') {
                return;
            }
            let row = event.currentTarget;
            let id = row.cells[1].textContent;
            console.log('Row clicked with ID:', id);
        };

        // Function to create sort indicator SVG
        function createSortIndicator(sortable = false, direction = 'none') {
            if (!sortable) return '';
            
            const upColor = direction === 'asc' ? 'var(--sl-color-neutral-500)' : 'var(--sl-color-neutral-300)';
            const downColor = direction === 'desc' ? 'var(--sl-color-neutral-500)' : 'var(--sl-color-neutral-300)';
            
            return `
                <span class="sort-indicator">
                    <svg width="10" height="16" viewBox="0 0 10 16" class="sort-svg">
                        <polygon points="5,3 1,7 9,7" fill="${upColor}" />
                        <polygon points="5,13 1,9 9,9" fill="${downColor}" />
                    </svg>
                </span>
            `;
        }

        // Function to create table headers dynamically
        function createTableHeaders() {
            const table = document.getElementById('data-table');
            if (!table) return false;

            const thead = table.querySelector('thead');
            if (!thead) return false;

            // Clear existing headers
            thead.innerHTML = '';

            // Create main header row
            const headerRow = document.createElement('tr');
            
            // Add checkbox column
            const checkboxHeader = document.createElement('th');
            checkboxHeader.className = 'checkbox-column';
            headerRow.appendChild(checkboxHeader);

            // Get visible columns
            const visibleColumns = getVisibleColumns();

            // Add column headers from visible definitions
            visibleColumns.forEach((col, index) => {
                const th = document.createElement('th');
                if (col.className) {
                    th.className = col.className;
                }
                
                // Apply text alignment
                if (col.align) {
                    th.style.textAlign = col.align;
                }
                
                th.innerHTML = col.title + createSortIndicator(col.sortable, col.sortDirection);
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);

            // Create filter row
            const filterRow = document.createElement('tr');
            filterRow.className = 'filter-row';
            
            // Add checkbox column for filter row
            const checkboxFilter = document.createElement('th');
            checkboxFilter.className = 'checkbox-column';
            checkboxFilter.innerHTML = '<sl-checkbox></sl-checkbox>';
            filterRow.appendChild(checkboxFilter);

            // Add filter inputs for each visible column
            visibleColumns.forEach(col => {
                const th = document.createElement('th');
                
                // Apply text alignment to filter row
                if (col.align) {
                    th.style.textAlign = col.align;
                }
                
                if (col.filterable) {
                    th.innerHTML = `<sl-input size="small" placeholder="${col.filterPlaceholder}" autocomplete="off"></sl-input>`;
                }
                filterRow.appendChild(th);
            });

            thead.appendChild(filterRow);

            // Add escape key handlers for filter inputs
            const filterInputs = filterRow.querySelectorAll('sl-input');
            filterInputs.forEach(input => {
                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        event.target.value = '';
                        console.log('Filter input cleared with Escape key');
                    }
                });
            });

            return true;
        }

        // Updated populate table function
        function populateTable() {
            
            // Find table using specific ID
            const table = document.getElementById('data-table');
            if (!table) {
                return false;
            }

            // Create headers dynamically
            if (!createTableHeaders()) {
                return false;
            }
             
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                 return false;
            }
             
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Get visible columns
            const visibleColumns = getVisibleColumns();

            // Add actual data rows
            tableData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Add checkbox cell
                const checkboxCell = document.createElement('td');
                checkboxCell.innerHTML = '<sl-checkbox></sl-checkbox>';
                tr.appendChild(checkboxCell);

                // Add data cells based on visible column definitions
                visibleColumns.forEach(col => {
                    const td = document.createElement('td');
                    
                    // Apply text alignment
                    if (col.align) {
                        td.style.textAlign = col.align;
                    }
                    
                    td.textContent = row[col.key];
                    tr.appendChild(td);
                });

                // Add row click handler
                tr.addEventListener('click', rowClicked);

                tbody.appendChild(tr);
            });
            
            return true;
        }

        // Function to clear the column search filter
        function clearColumnFilter() {
            const searchInput = document.querySelector('.columns-menu #column-search');
            if (searchInput) {
                searchInput.value = '';
                filterColumnMenu('');
                console.log('Column search filter cleared');
            }
        }

        // Function to filter column menu items by hiding/showing
        function filterColumnMenu(searchTerm) {
            const columnsMenu = document.querySelector('.columns-menu');
            if (!columnsMenu) {
                return;
            }

            const menuItems = columnsMenu.querySelectorAll('sl-menu-item[role="menuitemcheckbox"]');
            const lowerSearchTerm = searchTerm.toLowerCase();
            menuItems.forEach(item => {
                const columnTitle = item.textContent.toLowerCase();
                if (columnTitle.includes(lowerSearchTerm)) {
                    item.classList.remove('column-filter-hidden');
                } else {
                    item.classList.add('column-filter-hidden');
                }
            });
        }

        // Function to create columns menu dynamically
        function createColumnsMenu() {
            const columnsMenu = document.querySelector('.columns-menu');
            if (!columnsMenu) return false;

            // Clear existing menu items
            columnsMenu.innerHTML = '';

            // Add standard menu items
            const selectAll = document.createElement('sl-menu-item');
            selectAll.textContent = 'Select All';
            selectAll.setAttribute('data-action', 'select-all');
            columnsMenu.appendChild(selectAll);

            const clearAll = document.createElement('sl-menu-item');
            clearAll.textContent = 'Clear All';
            clearAll.setAttribute('data-action', 'clear-all');
            columnsMenu.appendChild(clearAll);

            const divider = document.createElement('sl-divider');
            columnsMenu.appendChild(divider);

            const searchInput = document.createElement('sl-input');
            searchInput.autofocus = true;
            searchInput.placeholder = 'Search columns...';
            searchInput.className = 'search-input';
            searchInput.setAttribute('id', 'column-search');
            searchInput.setAttribute('autocomplete', 'off');
            columnsMenu.appendChild(searchInput);

            // Add column items from definitions
            columnDefinitions.forEach(col => {
                const menuItem = document.createElement('sl-menu-item');
                menuItem.type = 'checkbox';
                menuItem.textContent = col.title;
                menuItem.setAttribute('data-column-key', col.key);
                // Set checkbox state based on column visibility
                menuItem.checked = col.visible;
                // Mark unhideable columns as disabled
                if (unhideableColumns.includes(col.key)) {
                    menuItem.setAttribute('data-unhideable', 'true');
                    menuItem.disabled = true;
                }
                columnsMenu.appendChild(menuItem);
            });

            // Add search functionality
            const searchElement = columnsMenu.querySelector('#column-search');
            if (searchElement) {
                ['input', 'sl-input', 'keyup', 'change'].forEach(eventType => {
                    searchElement.addEventListener(eventType, (event) => {
                        const value = event.target.value || '';
                        // Small delay to ensure DOM is ready
                        setTimeout(() => filterColumnMenu(value), 10);
                    });
                });

                // Add escape key handler for column search
                searchElement.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        event.target.value = '';
                        filterColumnMenu('');
                        console.log('Column search cleared with Escape key');
                    }
                });
            } else {
                console.log('Search element not found!');
            }

            return true;
        }

        // Initialize table with retry logic
        function initializeTable() {
            // set preselected columns visibility in columns definitions
            columnDefinitions.forEach(col => {
                if (preselectedColumns.includes(col.key) || unhideableColumns.includes(col.key)) {
                    col.visible = true;
                } else  {
                    col.visible = false;
                }
            });
            // Create columns menu
            createColumnsMenu();
            
            // Populate table
            populateTable();
            
            // Add focus behavior when dropdown opens
            const columnsDropdown = document.querySelector('sl-dropdown');
            if (columnsDropdown) {
                columnsDropdown.addEventListener('sl-show', () => {
                    // Small delay to ensure the dropdown content is rendered
                    setTimeout(() => {
                        const searchInput = document.querySelector('.columns-menu #column-search');
                        if (searchInput) {
                            searchInput.focus();
                            console.log('Column search input focused');
                        }
                    }, 50);
                });
            }

            // Add listener to column menu sl-select event
            const columnsMenu = document.querySelector('.columns-menu');
            if (columnsMenu) {
                columnsMenu.addEventListener('sl-select', (event) => {
                    const selectedItem = event.detail.item;
                    const action = selectedItem?.getAttribute('data-action');
                    const columnKey = selectedItem?.getAttribute('data-column-key');
                    
                    // Clear the column filter whenever any menu item is selected
                    clearColumnFilter();
                    
                    // Handle select all / clear all actions
                    if (action === 'select-all') {
                        selectAllColumns();
                        return;
                    } else if (action === 'clear-all') {
                        clearAllColumns();
                        return;
                    }
                    
                    if (columnKey) {
                        // Find the column definition
                        const columnDef = columnDefinitions.find(col => col.key === columnKey);
                        
                        if (columnDef) {
                            // Skip processing if item is disabled (unhideable columns)
                            if (selectedItem.disabled) {
                                event.preventDefault();
                                return;
                            }
                            
                            // Check if an unhideable column is being unselected (backup protection)
                            if (selectedItem.hasAttribute('data-unhideable') && unhideableColumns.includes(columnKey)) {
                                // Prevent unselecting unhideable columns
                                if (!selectedItem.checked) {
                                    selectedItem.checked = true;
                                    columnDef.visible = true;
                                    event.preventDefault();
                                    return;
                                }
                            }
                            
                            // Update the column visibility in definition
                            columnDef.visible = selectedItem.checked;
                        }
                    }
                    
                    populateTable();
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeTable();
        });
    </script>
    <div id="container">
        <!-- DATATABLE -->
        <!-- Toolbar -->
        <div class="toolbar">
            <div>
                <sl-button variant="success" circle>
                    <sl-icon name="plus"></sl-icon>
                </sl-button>
            </div>
            <div class="toolbar-center">
                <sl-button variant="danger">
                    <sl-icon name="trash"></sl-icon>
                </sl-button>
                <sl-button>Export to Excel</sl-button>
            </div>
            <div>
                <sl-dropdown>
                    <sl-button slot="trigger" caret>Columns</sl-button>
                    <sl-menu class="columns-menu">
                        <!-- Menu items will be created dynamically by createColumnsMenu() function -->
                    </sl-menu>
                </sl-dropdown>
            </div>
        </div>
        <div class="table-container">
            <table id="data-table">
                <thead>
                    <!-- Headers will be created dynamically by createTableHeaders() function -->
                </thead>
                <tbody>
                    <!-- Table rows will be populated dynamically by populateTable() function -->
                </tbody>
            </table>
        </div>
        <!-- FOOTER -->
        <div class="footer">
            <div id="item-count">Vybráno 10 z 500</div>
            <div class="items-per-page">
                Zobrazit
                <sl-dropdown>
                    <sl-button slot="trigger">
                        10
                        <sl-icon name="chevron-down" class="chevron-icon"></sl-icon>
                    </sl-button>

                    <sl-menu>
                        <sl-menu-item>5</sl-menu-item>
                        <sl-menu-item>10</sl-menu-item>
                        <sl-menu-item>20</sl-menu-item>
                        <sl-menu-item>50</sl-menu-item>
                        <sl-menu-item>100</sl-menu-item>
                        <sl-menu-item>1000</sl-menu-item>
                    </sl-menu>
                </sl-dropdown>
                na stránku
            </div>
            <!-- PAGER -->
            <div class="pager" onclick="pageDropdownClicked(event)">
                <sl-button-group>
                    <sl-button disabled>
                        <sl-icon name="chevron-bar-left"></sl-icon>
                    </sl-button>
                    <sl-button disabled>
                        <sl-icon name="chevron-left"></sl-icon>
                    </sl-button>
                </sl-button-group>
                <div id="page-info" variant="none">
                    Stránka
                    <sl-input id="page-number" size="small" value="8" onclick="inputClick(event)"
                        onkeydown="inputKeyDown(event)" onblur="inputBlur(event)"></sl-input>
                    / 15
                </div>

                <sl-button-group>
                    <sl-button>
                        <sl-icon name="chevron-right"></sl-icon>
                    </sl-button>
                    <sl-button>
                        <sl-icon name="chevron-bar-right"></sl-icon>
                    </sl-button>
                </sl-button-group>
            </div>
        </div>
    </div>
</div>